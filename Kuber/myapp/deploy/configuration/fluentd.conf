<source>
  @type tail
  path /logs/app1/log*.txt
  pos_file /work/posfile_app1.pos
  read_from_head true
  follow_inodes true
  path_key logfile
  tag mylogs.app1
  from_encoding utf-8
  encoding utf-8
  multiline_flush_interval 5s
  <parse>
    @type multiline
    format_firstline /^(?:FATAL|ERROR|WARN|INFO|DEBUG|TRACE)\|\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2}\.\d{4}\|(?:[\d\w.]*(?::[\d\w]*)?):/
    format1 /^(?<level>FATAL|ERROR|WARN|INFO|DEBUG|TRACE)\|(?<time>\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2}\.\d{3})\d{1}\|(?<logger>[\d\w.]*(?::[\d\w]*)?):\n(?<message>.*)/
    time_key time
    time_format %Y-%m-%d %H:%M:%S.%L
    keep_time_key false
  </parse>
</source>

<source>
  @type tail
  path /logs/app2/log*.txt
  pos_file /work/posfile_app2.pos
  read_from_head true
  follow_inodes true
  path_key logfile
  tag mylogs.app2
  from_encoding utf-8
  encoding utf-8
  multiline_flush_interval 5s
  <parse>
    @type multiline
    format_firstline /^(?:FATAL|ERROR|WARN|INFO|DEBUG|TRACE)\|\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2}\.\d{4}\|(?:[\d\w.]*(?::[\d\w]*)?):/
    format1 /^(?<level>FATAL|ERROR|WARN|INFO|DEBUG|TRACE)\|(?<time>\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2}\.\d{3})\d{1}\|(?<logger>[\d\w.]*(?::[\d\w]*)?):\n(?<message>.*)/
    time_key time
    time_format %Y-%m-%d %H:%M:%S.%L
    keep_time_key false
  </parse>
</source>

<filter mylogs.*>
  @type record_modifier
  <record>
    hostname "#{Socket.gethostname}"
    source ${tag_parts[1]}
    index_name ${tag}.${Time.at(time).strftime('%Y%m')}
  </record>
</filter>

<match mylogs.*>
  @type opensearch
  hosts https://my_elastic:92000
  user my@user
  password 1234
  ca_file /fluentd/trusted_root_certs.crt
  ssl_verify true
  
  target_index_key index_name
  index_name ${tag}.fallback
  include_timestamp true

  <buffer tag>
    @type memory
    flush_interval 5s
    delayed_commit_timeout 5s
  </buffer>
</match>
