FROM registry.access.redhat.com/ubi8/nginx-120:1-7 AS lbbase
USER root

FROM registry.access.redhat.com/ubi8/ruby-30:1-4 AS lcbase
USER root
WORKDIR /
COPY ["build/rpm_packages/calyptia-fluentd-1.3.4-1.el8.x86_64.rpm", "."]
RUN rpm --install calyptia-fluentd-1.3.4-1.el8.x86_64.rpm&& rm -f calyptia-fluentd-1.3.4-1.el8.x86_64.rpm

FROM registry.access.redhat.com/ubi8/dotnet-60:6.0-3 AS buildbase
USER root
WORKDIR /
COPY ["build/rpm_packages/powershell-lts-7.2.1-1.rh.x86_64.rpm", "."]
RUN rpm --install powershell-lts-7.2.1-1.rh.x86_64.rpm && rm -f powershell-lts-7.2.1-1.rh.x86_64.rpm

FROM registry.access.redhat.com/ubi8/nodejs-16:1-8 AS nodebase
USER root
WORKDIR /

FROM registry.access.redhat.com/ubi8/dotnet-50-runtime:5.0-39 AS aspnetbase
USER root
ENV ASPNETCORE_URLS=http://*:5000
STOPSIGNAL SIGINT
ENV DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=false
ENV LC_ALL=C.UTF-8
WORKDIR /

FROM aspnetbase AS toolsbase
COPY ["build/rpm_packages/utils", "/rpm_packages"]
RUN rpm -i /rpm_packages/*.rpm && rm -rf /rpm_packages
COPY ["build/rpm_packages/powershell-lts-7.2.1-1.rh.x86_64.rpm", "."]
RUN rpm --install powershell-lts-7.2.1-1.rh.x86_64.rpm && rm -f powershell-lts-7.2.1-1.rh.x86_64.rpm
COPY ["build/rpm_packages/krb5-workstation", "/rpm_packages"]
RUN rpm --upgrade /rpm_packages/*.rpm && rm -rf /rpm_packages
COPY ["build/rpm_packages/openldap-clients-2.4.46-18.el8.x86_64.rpm", "."]
RUN rpm --install openldap-clients-2.4.46-18.el8.x86_64.rpm && rm -f openldap-clients-2.4.46-18.el8.x86_64.rpm
